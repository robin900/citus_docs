

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Real Time Aggregation &mdash; Citus 5.0.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Citus 5.0.0 documentation" href="../index.html"/>
        <link rel="next" title="Updatable User Data" href="tut-user-data.html"/>
        <link rel="prev" title="Start Demo Cluster" href="tut-cluster.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <div class="header">
  <div class="section-wrap"> 
              <div class="utility-nav">
              </div>
                      <a href="https://www.citusdata.com" title="Citus Data" rel="home" class="logo">
            <img src="https://www.citusdata.com/sites/default/files/logo_0_0.png" alt="Citus Data">
          </a>
              <div class="clear"></div>
  </div>
  </div>
  <div class="nav-wrap menu">
    <div class="section-wrap">
      <ul>
        <li><a href="https://www.citusdata.com/product/citus">Product</a></li>
        <li><a href="https://www.citusdata.com/solutions/applications">Solutions</a></li>
        <li><a href="https://www.citusdata.com/blog">Blog</a></li>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
  </div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Citus
          

          
          </a>

          
            
            
              <div class="version">
                5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">About Citus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/what_is_citus.html">What is Citus?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/introduction_to_citus.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tut-cluster.html">Start Demo Cluster</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Real Time Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tut-user-data.html">Updatable User Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/development.html">Single-Machine Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/production.html">Multi-Machine Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/working_with_distributed_tables.html">Working with distributed tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/append_distribution.html">Append Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/hash_distribution.html">Hash Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/range_distribution.html">Range Distribution (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/querying.html">Querying Distributed Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/postgresql_extensions.html">PostgreSQL extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/query_processing.html">Citus Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/scaling_data_ingestion.html">Scaling Out Data Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/upgrading_citus.html">Upgrading to Citus 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/transitioning_from_postgresql_to_citus.html">Transitioning From PostgreSQL to Citus</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/citus_sql_reference.html">Citus SQL Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_defined_functions.html">User Defined Functions Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/metadata_tables.html">Metadata Tables Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <a href="../index.html">Citus</a>
      <ul>
        <li><a href="/product/citus">Product</a></li>
        <li><a href="/solutions/applications">Solutions</a></li>
        <li><a href="/blog">Blog</a></li>
      </ul>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Real Time Aggregation</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="real-time-aggregation">
<h1>Real Time Aggregation<a class="headerlink" href="#real-time-aggregation" title="Permalink to this headline">Â¶</a></h1>
<p>In this tutorial we&#8217;ll look at a stream of live wikipedia edits. Wikimedia is
kind enough to publish all changes happening across all their sites in real time;
this can be a lot of events!</p>
<p>This tutorial assumes you&#8217;ve set up a <a class="reference internal" href="tut-cluster.html#tut-cluster"><span class="std std-ref">single-machine demo cluster</span></a>.
Our first task is to get the cluster ready to accept a stream of wikipedia edits.
First, open a psql shell to the master:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> citus-tutorial
bin/psql postgresql://:9700
</pre></div>
</div>
<p>This will open a new prompt. You can leave psql at any time by hitting
<code class="kbd docutils literal"><span class="pre">Ctrl</span></code> + <code class="kbd docutils literal"><span class="pre">D</span></code>.</p>
<p>Create a table for the wikipedia data to be entered into:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wikipedia_edits</span> <span class="p">(</span>
  <span class="n">time</span> <span class="k">TIMESTAMP</span> <span class="k">WITH</span> <span class="n">TIME</span> <span class="k">ZONE</span><span class="p">,</span> <span class="c1">-- When the edit was made</span>

  <span class="n">editor</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The editor who made the change</span>
  <span class="n">bot</span> <span class="nb">BOOLEAN</span><span class="p">,</span> <span class="c1">-- Whether the editor is a bot</span>

  <span class="n">wiki</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">--  Which wiki was edited</span>
  <span class="n">namespace</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- Which namespace the page is a part of</span>
  <span class="n">title</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The name of the page</span>

  <span class="k">comment</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The message they described the change with</span>
  <span class="n">minor</span> <span class="nb">BOOLEAN</span><span class="p">,</span> <span class="c1">-- Whether this was a minor edit (self-reported)</span>
  <span class="k">type</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- &quot;new&quot; if this created the page, &quot;edit&quot; otherwise</span>

  <span class="n">old_length</span> <span class="nb">INT</span><span class="p">,</span> <span class="c1">-- How long the page used to be</span>
  <span class="n">new_length</span> <span class="nb">INT</span> <span class="c1">-- How long the page is as of this edit</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">wikipedia_edits</span></code> table is currently a regular Postgres table. Its growth
is limited by how much data the master can hold and queries against it don&#8217;t
benefit from any parallelism.</p>
<p>Tell Citus that it should be a distributed table:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">master_create_distributed_table</span><span class="p">(</span>
  <span class="s1">&#39;wikipedia_edits&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>This says to append distribute
the <code class="docutils literal"><span class="pre">wikipedia_edits</span></code> table using the <code class="docutils literal"><span class="pre">time</span></code> column. The table will be
stored as a collection of shards, each responsible for a range of <code class="docutils literal"><span class="pre">time</span></code>
values. The page on <a class="reference internal" href="../dist_tables/append_distribution.html#append-distribution"><span class="std std-ref">Append Distribution</span></a> goes into more detail.</p>
<p>Each shard can be on a different worker, letting the table grow to sizes too
big for any one node to handle. Queries against this table run across all
shards in parallel. Even on a single machine, this can have some significant
performance benefits!</p>
<p>By default, Citus will replicate each shard across multiple workers. Since we
only have one worker, we have to tell Citus that not replicating is okay:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SET</span> <span class="n">citus</span><span class="p">.</span><span class="n">shard_replication_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>If we didn&#8217;t do the above, when we went to create a shard Citus would give us
an error rather than accepting data it can&#8217;t backup.</p>
<p>Now we create a shard for the data to be inserted into:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">master_create_empty_shard</span><span class="p">(</span><span class="s1">&#39;wikipedia_edits&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Citus is eagerly awaiting data, let&#8217;s give it some! <strong>Open a separate
terminal</strong> and run the data ingest script we&#8217;ve made for you.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># - in a new terminal -</span>

<span class="nb">cd</span> citus-tutorial
scripts/insert-live-wikipedia-edits postgresql://:9700
</pre></div>
</div>
<p>This should continue running and adding edits, let&#8217;s run some queries
on them!  If you run any of these queries multiple times you&#8217;ll see
the results update.  Data is available to be queried in Citus as
soon as it is ingested. Returning to our psql session on the master
node we can ask who the most prolific editors are:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- back in the original (psql) terminal</span>

<span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">edits</span><span class="p">,</span> <span class="n">editor</span>
<span class="k">FROM</span> <span class="n">wikipedia_edits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="p">;</span>
</pre></div>
</div>
<p>This is likely to be dominated by bots, so we can look at just the sources
which represent actual users:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">edits</span><span class="p">,</span> <span class="n">editor</span>
<span class="k">FROM</span> <span class="n">wikipedia_edits</span> <span class="k">WHERE</span> <span class="n">bot</span> <span class="k">IS</span> <span class="k">false</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="p">;</span>
</pre></div>
</div>
<p>Unfortunately, &#8216;bot&#8217; is a user-settable flag which many bots forget to send, so
this list is usually also dominated by bots.</p>
<p>Another user-settable flag is &#8220;minor&#8221;, which users can hit to indicate they&#8217;ve
made a small change which doesn&#8217;t need to be reviewed as carefully. Let&#8217;s see
if they&#8217;re actually following instructions:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="k">avg</span><span class="p">(</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">minor</span> <span class="k">THEN</span> <span class="k">abs</span><span class="p">(</span><span class="n">new_length</span> <span class="o">-</span> <span class="n">old_length</span><span class="p">)</span> <span class="k">END</span>
  <span class="p">)</span> <span class="k">AS</span> <span class="n">average_minor_edit_size</span><span class="p">,</span>
  <span class="k">avg</span><span class="p">(</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">NOT</span> <span class="n">minor</span> <span class="k">THEN</span> <span class="k">abs</span><span class="p">(</span><span class="n">new_length</span> <span class="o">-</span> <span class="n">old_length</span><span class="p">)</span> <span class="k">END</span>
  <span class="p">)</span> <span class="k">AS</span> <span class="n">average_normal_edit_size</span>
<span class="k">FROM</span> <span class="n">wikipedia_edits</span>
<span class="k">WHERE</span> <span class="n">old_length</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">new_length</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>Or how about combining the two? What are the top contributors, and how big are their edits?</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_edits</span><span class="p">,</span>
  <span class="n">editor</span><span class="p">,</span>
  <span class="k">avg</span><span class="p">(</span><span class="k">abs</span><span class="p">(</span><span class="n">new_length</span> <span class="o">-</span> <span class="n">old_length</span><span class="p">))</span> <span class="k">AS</span> <span class="n">average_edit_size</span>
<span class="k">FROM</span> <span class="n">wikipedia_edits</span>
<span class="k">WHERE</span> <span class="n">new_length</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">old_length</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="p">;</span>
</pre></div>
</div>
<p>That&#8217;s all for now. To learn more about Citus continue to the <a class="reference internal" href="tut-user-data.html"><span class="doc">next
tutorial</span></a>, or, if you&#8217;re done with the cluster, run this to
stop the worker and master:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>bin/pg_ctl -D data/master stop
bin/pg_ctl -D data/worker stop
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tut-user-data.html" class="btn btn-neutral float-right" title="Updatable User Data" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tut-cluster.html" class="btn btn-neutral" title="Start Demo Cluster" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Citus Data.

    </p>
  </div> 

</footer>

          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32858865-1', 'auto');
  ga('send', 'pageview');

</script>
<script>
/**
* Function that tracks a click on an outbound link in Analytics.
* This function takes a valid URL string as an argument, and uses that URL string
* as the event label. Setting the transport method to 'beacon' lets the hit be sent
* using 'navigator.sendBeacon' in browser that support it.
*/
var trackOutboundLink = function(url) {
   ga('send', 'event', 'outbound', 'click', url, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script>

        </div>
      </div>

    </section>

  </div>
  
<h3>Versions</h3>
<ul>
    <li><a href="../../v5.2/index.html">v5.2</a></li>
    <li><a href="../../v5.1/index.html">v5.1</a></li>
    <li><a href="tut-real-time.html">v5.0</a></li>
</ul>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>