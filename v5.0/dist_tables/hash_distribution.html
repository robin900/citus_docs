

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hash Distribution &mdash; Citus 5.0.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Citus 5.0.0 documentation" href="../index.html"/>
        <link rel="next" title="Range Distribution (Manual)" href="range_distribution.html"/>
        <link rel="prev" title="Append Distribution" href="append_distribution.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <div class="header">
  <div class="section-wrap"> 
              <div class="utility-nav">
              </div>
                      <a href="https://www.citusdata.com" title="Citus Data" rel="home" class="logo">
            <img src="https://www.citusdata.com/sites/default/files/logo_0_0.png" alt="Citus Data">
          </a>
              <div class="clear"></div>
  </div>
  </div>
  <div class="nav-wrap menu">
    <div class="section-wrap">
      <ul>
        <li><a href="https://www.citusdata.com/product/citus">Product</a></li>
        <li><a href="https://www.citusdata.com/solutions/applications">Solutions</a></li>
        <li><a href="https://www.citusdata.com/blog">Blog</a></li>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
  </div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Citus
          

          
          </a>

          
            
            
              <div class="version">
                5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">About Citus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/what_is_citus.html">What is Citus?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/introduction_to_citus.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-cluster.html">Start Demo Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-real-time.html">Real Time Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-user-data.html">Updatable User Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/development.html">Single-Machine Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/production.html">Multi-Machine Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Tables</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="working_with_distributed_tables.html">Working with distributed tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="append_distribution.html">Append Distribution</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hash Distribution</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-and-distributing-tables">Creating And Distributing Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inserting-data">Inserting Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-row-inserts">Single row inserts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bulk-inserts">Bulk inserts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#updating-and-deleting-data">Updating and Deleting Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#maximizing-write-performance">Maximizing Write Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dropping-tables">Dropping Tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="range_distribution.html">Range Distribution (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html">Querying Distributed Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="postgresql_extensions.html">PostgreSQL extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/query_processing.html">Citus Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/scaling_data_ingestion.html">Scaling Out Data Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/upgrading_citus.html">Upgrading to Citus 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/transitioning_from_postgresql_to_citus.html">Transitioning From PostgreSQL to Citus</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/citus_sql_reference.html">Citus SQL Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_defined_functions.html">User Defined Functions Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/metadata_tables.html">Metadata Tables Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <a href="../index.html">Citus</a>
      <ul>
        <li><a href="/product/citus">Product</a></li>
        <li><a href="/solutions/applications">Solutions</a></li>
        <li><a href="/blog">Blog</a></li>
      </ul>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Hash Distribution</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hash-distribution">
<span id="id1"></span><h1>Hash Distribution<a class="headerlink" href="#hash-distribution" title="Permalink to this headline">Â¶</a></h1>
<p>Hash distributed tables are best suited for use cases which require real-time inserts
and updates. They also allow for faster key-value lookups and efficient joins on the
distribution column. In the next few sections, we describe how
you can create and distribute tables using the hash distribution method, and do real
time inserts and updates to your data in addition to analytics.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The instructions below assume that the PostgreSQL installation is in your path. If not, you will need to add it to your PATH environment variable. For example:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>export PATH=/usr/lib/postgresql/9.5/:$PATH
</pre></div>
</div>
</div>
<p>We use the github events dataset to illustrate the commands below. You can download that dataset by running:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">examples</span><span class="o">.</span><span class="n">citusdata</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">github_archive</span><span class="o">/</span><span class="n">github_events</span><span class="o">-</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">gz</span>
<span class="n">gzip</span> <span class="o">-</span><span class="n">d</span> <span class="n">github_events</span><span class="o">-</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-*.</span><span class="n">gz</span>
</pre></div>
</div>
<div class="section" id="creating-and-distributing-tables">
<h2>Creating And Distributing Tables<a class="headerlink" href="#creating-and-distributing-tables" title="Permalink to this headline">Â¶</a></h2>
<p>To create a hash distributed table, you need to first define the table schema. To do so, you can define a table using the <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-createtable.html">CREATE TABLE</a> statement in the same way as you would do with a regular PostgreSQL table.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgres</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">github_events</span>
<span class="p">(</span>
    <span class="n">event_id</span> <span class="n">bigint</span><span class="p">,</span>
    <span class="n">event_type</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">event_public</span> <span class="n">boolean</span><span class="p">,</span>
    <span class="n">repo_id</span> <span class="n">bigint</span><span class="p">,</span>
    <span class="n">payload</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">repo</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">actor</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">org</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="n">timestamp</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Next, you can use the master_create_distributed_table() function to mark the table as a hash distributed table and specify its distribution column.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">master_create_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span> <span class="s1">&#39;repo_id&#39;</span><span class="p">,</span> <span class="s1">&#39;hash&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>This function informs Citus that the github_events table should be distributed by hash on the repo_id column.</p>
<p>Then, you can create shards for the distributed table on the worker nodes using the master_create_worker_shards() UDF.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">master_create_worker_shards</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>This UDF takes two arguments in addition to the table name; shard count and the replication factor. This example would create a total of sixteen shards where each shard owns a portion of a hash token space and gets replicated on one worker. The shard replica created on the worker has the same table schema, index, and constraint definitions as the table on the master. Once the replica is created, this function saves all distributed metadata on the master.</p>
<p>Each created shard is assigned a unique shard id and all its replicas have the same shard id. Each shard is represented on the worker node as a regular PostgreSQL table with name &#8216;tablename_shardid&#8217; where tablename is the name of the distributed table and shardid is the unique id assigned to that shard. You can connect to the worker postgres instances to view or run commands on individual shards.</p>
<p>After creating the worker shard, you are ready to insert data into the hash distributed table and run queries on it. You can also learn more about the UDFs used in this section in the <a class="reference internal" href="../reference/user_defined_functions.html#user-defined-functions"><span class="std std-ref">User Defined Functions Reference</span></a> of our documentation.</p>
</div>
<div class="section" id="inserting-data">
<h2>Inserting Data<a class="headerlink" href="#inserting-data" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="single-row-inserts">
<h3>Single row inserts<a class="headerlink" href="#single-row-inserts" title="Permalink to this headline">Â¶</a></h3>
<p>To insert data into hash distributed tables, you can use the standard PostgreSQL <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-insert.html">INSERT</a> commands. As an example, we pick two rows randomly from the Github Archive dataset.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">github_events</span> <span class="n">VALUES</span> <span class="p">(</span><span class="mi">2489373118</span><span class="p">,</span><span class="s1">&#39;PublicEvent&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="mi">24509048</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;{&quot;id&quot;: 24509048, &quot;url&quot;: &quot;https://api.github.com/repos/SabinaS/csee6868&quot;, &quot;name&quot;: &quot;SabinaS/csee6868&quot;}&#39;</span><span class="p">,</span><span class="s1">&#39;{&quot;id&quot;: 2955009, &quot;url&quot;: &quot;https://api.github.com/users/SabinaS&quot;, &quot;login&quot;: &quot;SabinaS&quot;, &quot;avatar_url&quot;: &quot;https://avatars.githubusercontent.com/u/2955009?&quot;, &quot;gravatar_id&quot;: &quot;&quot;}&#39;</span><span class="p">,</span><span class="n">NULL</span><span class="p">,</span><span class="s1">&#39;2015-01-01 00:09:13&#39;</span><span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">github_events</span> <span class="n">VALUES</span> <span class="p">(</span><span class="mi">2489368389</span><span class="p">,</span><span class="s1">&#39;WatchEvent&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="mi">28229924</span><span class="p">,</span><span class="s1">&#39;{&quot;action&quot;: &quot;started&quot;}&#39;</span><span class="p">,</span><span class="s1">&#39;{&quot;id&quot;: 28229924, &quot;url&quot;: &quot;https://api.github.com/repos/inf0rmer/blanket&quot;, &quot;name&quot;: &quot;inf0rmer/blanket&quot;}&#39;</span><span class="p">,</span><span class="s1">&#39;{&quot;id&quot;: 1405427, &quot;url&quot;: &quot;https://api.github.com/users/tategakibunko&quot;, &quot;login&quot;: &quot;tategakibunko&quot;, &quot;avatar_url&quot;: &quot;https://avatars.githubusercontent.com/u/1405427?&quot;, &quot;gravatar_id&quot;: &quot;&quot;}&#39;</span><span class="p">,</span><span class="n">NULL</span><span class="p">,</span><span class="s1">&#39;2015-01-01 00:00:24&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>When inserting rows into hash distributed tables, the distribution column of the row being inserted must be specified. Based on the distribution column, Citus determines the right shard to which the insert should be routed to. Then, the query is forwarded to the right shard, and the remote insert command is executed on all the replicas of that shard.</p>
</div>
<div class="section" id="bulk-inserts">
<h3>Bulk inserts<a class="headerlink" href="#bulk-inserts" title="Permalink to this headline">Â¶</a></h3>
<p>Sometimes, you may want to bulk load several rows together into your hash distributed tables. To facilitate this, a script named copy_to_distributed_table is provided for loading many rows of data from a file, similar to the functionality provided by <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-copy.html">PostgreSQL&#8217;s COPY command</a>. It is automatically installed into the bin directory for your PostgreSQL installation.</p>
<p>Before invoking the script, you should set the environment variables which will be used as connection parameters while connecting to your Postgres server. For example, to set the default database to postgres, you can run the command shown below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">PGDATABASE</span><span class="o">=</span><span class="n">postgres</span>
</pre></div>
</div>
<p>As an example usage for the script, the invocation below would copy rows into the github_events table from a CSV file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">copy_to_distributed_table</span> <span class="o">-</span><span class="n">C</span> <span class="n">github_events</span><span class="o">-</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mf">0.</span><span class="n">csv</span> <span class="n">github_events</span>
</pre></div>
</div>
<p>To learn more about the different options supported by the script, you can call the script with -h for usage information.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">copy_to_distributed_table</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>Note that hash distributed tables are optimised for real-time ingestion, where users typically have to do single row inserts into distributed tables. Bulk loading, though supported, is generally slower than tables using the append distribution method. For use cases involving bulk loading of data, please consider using <a class="reference internal" href="append_distribution.html#append-distribution"><span class="std std-ref">Append Distribution</span></a>.</p>
</div>
</div>
<div class="section" id="updating-and-deleting-data">
<h2>Updating and Deleting Data<a class="headerlink" href="#updating-and-deleting-data" title="Permalink to this headline">Â¶</a></h2>
<p>You can also update or delete rows from your tables, using the standard PostgreSQL <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-update.html">UPDATE</a> and <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-delete.html">DELETE</a> commands.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">UPDATE</span> <span class="n">github_events</span> <span class="n">SET</span> <span class="n">org</span> <span class="o">=</span> <span class="n">NULL</span> <span class="n">WHERE</span> <span class="n">repo_id</span> <span class="o">=</span> <span class="mi">24509048</span><span class="p">;</span>
<span class="n">DELETE</span> <span class="n">FROM</span> <span class="n">github_events</span> <span class="n">WHERE</span> <span class="n">repo_id</span> <span class="o">=</span> <span class="mi">24509048</span><span class="p">;</span>
</pre></div>
</div>
<p>Currently, Citus requires that an UPDATE or DELETE involves exactly one shard. This means commands must include a WHERE qualification on the distribution column that restricts the query to a single shard. Such qualifications usually take the form of an equality clause on the tableâs distribution column.</p>
</div>
<div class="section" id="maximizing-write-performance">
<h2>Maximizing Write Performance<a class="headerlink" href="#maximizing-write-performance" title="Permalink to this headline">Â¶</a></h2>
<p>Both INSERT and UPDATE/DELETE statements can be scaled up to around 50,000 queries per second on large machines. However, to achieve this rate, you will need to use many parallel, long-lived connections and consider how to deal with locking. For more information, you can consult the <a class="reference internal" href="../performance/scaling_data_ingestion.html#scaling-data-ingestion"><span class="std std-ref">Scaling Out Data Ingestion</span></a> section of our documentation.</p>
</div>
<div class="section" id="dropping-tables">
<h2>Dropping Tables<a class="headerlink" href="#dropping-tables" title="Permalink to this headline">Â¶</a></h2>
<p>You can use the standard PostgreSQL DROP TABLE command to remove your hash distributed tables. As with regular tables, DROP TABLE removes any indexes, rules, triggers, and constraints that exist for the target table. In addition, it also drops the shards on the worker nodes and cleans up their metadata.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">github_events</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="range_distribution.html" class="btn btn-neutral float-right" title="Range Distribution (Manual)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="append_distribution.html" class="btn btn-neutral" title="Append Distribution" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Citus Data.

    </p>
  </div> 

</footer>

          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32858865-1', 'auto');
  ga('send', 'pageview');

</script>
<script>
/**
* Function that tracks a click on an outbound link in Analytics.
* This function takes a valid URL string as an argument, and uses that URL string
* as the event label. Setting the transport method to 'beacon' lets the hit be sent
* using 'navigator.sendBeacon' in browser that support it.
*/
var trackOutboundLink = function(url) {
   ga('send', 'event', 'outbound', 'click', url, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script>

        </div>
      </div>

    </section>

  </div>
  
<h3>Versions</h3>
<ul>
    <li><a href="../../v5.2/index.html">v5.2</a></li>
    <li><a href="../../v5.1/dist_tables/hash_distribution.html">v5.1</a></li>
    <li><a href="hash_distribution.html">v5.0</a></li>
</ul>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>