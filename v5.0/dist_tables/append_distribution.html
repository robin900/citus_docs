

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Append Distribution &mdash; Citus 5.0.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Citus 5.0.0 documentation" href="../index.html"/>
        <link rel="next" title="Hash Distribution" href="hash_distribution.html"/>
        <link rel="prev" title="Working with distributed tables" href="working_with_distributed_tables.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <div class="header">
  <div class="section-wrap"> 
              <div class="utility-nav">
              </div>
                      <a href="https://www.citusdata.com" title="Citus Data" rel="home" class="logo">
            <img src="https://www.citusdata.com/sites/default/files/logo_0_0.png" alt="Citus Data">
          </a>
              <div class="clear"></div>
  </div>
  </div>
  <div class="nav-wrap menu">
    <div class="section-wrap">
      <ul>
        <li><a href="https://www.citusdata.com/product/citus">Product</a></li>
        <li><a href="https://www.citusdata.com/solutions/applications">Solutions</a></li>
        <li><a href="https://www.citusdata.com/blog">Blog</a></li>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
  </div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Citus
          

          
          </a>

          
            
            
              <div class="version">
                5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">About Citus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/what_is_citus.html">What is Citus?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/introduction_to_citus.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-cluster.html">Start Demo Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-real-time.html">Real Time Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-user-data.html">Updatable User Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/development.html">Single-Machine Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/production.html">Multi-Machine Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Tables</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="working_with_distributed_tables.html">Working with distributed tables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Append Distribution</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-and-distributing-tables">Creating and Distributing Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-loading">Data Loading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bulk-load-using-stage">Bulk load using \stage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#incremental-loads-by-appending-to-existing-shards">Incremental loads by appending to existing shards</a></li>
<li class="toctree-l3"><a class="reference internal" href="#increasing-data-loading-performance">Increasing data loading performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dropping-shards">Dropping Shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dropping-tables">Dropping Tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hash_distribution.html">Hash Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="range_distribution.html">Range Distribution (Manual)</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html">Querying Distributed Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="postgresql_extensions.html">PostgreSQL extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/query_processing.html">Citus Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/scaling_data_ingestion.html">Scaling Out Data Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/upgrading_citus.html">Upgrading to Citus 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/transitioning_from_postgresql_to_citus.html">Transitioning From PostgreSQL to Citus</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/citus_sql_reference.html">Citus SQL Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_defined_functions.html">User Defined Functions Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/metadata_tables.html">Metadata Tables Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <a href="../index.html">Citus</a>
      <ul>
        <li><a href="/product/citus">Product</a></li>
        <li><a href="/solutions/applications">Solutions</a></li>
        <li><a href="/blog">Blog</a></li>
      </ul>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Append Distribution</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="append-distribution">
<span id="id1"></span><h1>Append Distribution<a class="headerlink" href="#append-distribution" title="Permalink to this headline">¶</a></h1>
<p>Append distributed tables are best suited to append-only event data
which arrives in a time-ordered series. In the next few sections, we describe how
users can create append distributed tables, load data into them and also expire
old data from them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The instructions below assume that the PostgreSQL installation is in your path. If not, you will need to add it to your PATH environment variable. For example:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>export PATH=/usr/lib/postgresql/9.5/:$PATH
</pre></div>
</div>
</div>
<p>We use the github events dataset to illustrate the commands below. You can download that dataset by running:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">examples</span><span class="o">.</span><span class="n">citusdata</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">github_archive</span><span class="o">/</span><span class="n">github_events</span><span class="o">-</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">gz</span>
<span class="n">gzip</span> <span class="o">-</span><span class="n">d</span> <span class="n">github_events</span><span class="o">-</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-*.</span><span class="n">gz</span>
</pre></div>
</div>
<div class="section" id="creating-and-distributing-tables">
<h2>Creating and Distributing Tables<a class="headerlink" href="#creating-and-distributing-tables" title="Permalink to this headline">¶</a></h2>
<p>To create an append distributed table, you need to first define the table schema. To do so, you can define a table using the <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-createtable.html">CREATE TABLE</a> statement in the same way as you would do with a regular PostgreSQL table.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">csql</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgres</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">github_events</span>
<span class="p">(</span>
    <span class="n">event_id</span> <span class="n">bigint</span><span class="p">,</span>
    <span class="n">event_type</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">event_public</span> <span class="n">boolean</span><span class="p">,</span>
    <span class="n">repo_id</span> <span class="n">bigint</span><span class="p">,</span>
    <span class="n">payload</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">repo</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">actor</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">org</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="n">timestamp</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Next, you can use the master_create_distributed_table() function to mark the table as an append distributed table and specify its distribution column.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">master_create_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>This function informs Citus that the github_events table should be distributed by append on the created_at column. Note that this method doesn&#8217;t enforce a particular distribution; it merely tells the database to keep minimum and maximum values for the created_at column in each shard which are later used by the database for optimizing queries.</p>
</div>
<div class="section" id="data-loading">
<h2>Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h2>
<p>Citus supports two methods to load data into your append distributed tables. The first one is suitable for bulk loads from CSV/TSV files and involves using the stage command. For use cases requiring smaller, incremental data loads, Citus provides two user defined functions. We describe each of the methods and their usage below.</p>
<div class="section" id="bulk-load-using-stage">
<h3>Bulk load using \stage<a class="headerlink" href="#bulk-load-using-stage" title="Permalink to this headline">¶</a></h3>
<p>The stage command is used to copy data from a file to a distributed table while handling replication and failures automatically. It is not available in the standard <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/app-psql.html">psql</a> client. Instead, Citus provides a database client called csql which supports all the commands of psql plus the stage command.</p>
<p>Note: You can use the psql client if you do not wish to use stage to ingest data. In upcoming releases, stage will be replaced by more native ingest methods which will remove the need for csql.</p>
<p>The stage command borrows its syntax from the <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/app-psql.html">client-side copy command</a> in PostgreSQL. Behind the scenes, stage first opens a connection to the master and fetches candidate workers on which to create new shards. Then, the command connects to these workers, creates at least one shard there, and uploads the data to the shards. The command then replicates these shards on other workers until the replication factor is satisfied and fetches statistics for these shards. Finally, the command stores the shard metadata with the master.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SET</span> <span class="n">citus</span><span class="o">.</span><span class="n">shard_max_size</span> <span class="n">TO</span> <span class="s1">&#39;64MB&#39;</span><span class="p">;</span>
<span class="n">SET</span> <span class="n">citus</span><span class="o">.</span><span class="n">shard_replication_factor</span> <span class="n">TO</span> <span class="mi">1</span><span class="p">;</span>
\<span class="n">stage</span> <span class="n">github_events</span> <span class="kn">from</span> <span class="s1">&#39;github_events-2015-01-01-0.csv&#39;</span> <span class="n">WITH</span> <span class="n">CSV</span><span class="p">;</span>
</pre></div>
</div>
<p>Citus assigns a unique shard id to each new shard and all its replicas have the same shard id. Each shard is represented on the worker node as a regular PostgreSQL table with name &#8216;tablename_shardid&#8217; where tablename is the name of the distributed table and shardid is the unique id assigned to that shard. One can connect to the worker postgres instances to view or run commands on individual shards.</p>
<p>By default, the stage command depends on two configuration parameters for its behavior. These are called citus.shard_max_size and citus.shard_replication_factor.</p>
<ol class="arabic simple">
<li><strong>citus.shard_max_size :-</strong> This parameter determines the maximum size of a shard created using stage, and defaults to 1 GB. If the file is larger than this parameter, stage will break it up into multiple shards.</li>
<li><strong>citus.shard_replication_factor :-</strong> This parameter determines the number of nodes each shard gets replicated to, and defaults to two. The ideal value for this parameter depends on the size of the cluster and rate of node failure. For example, you may want to increase the replication factor if you run large clusters and observe node failures on a more frequent basis.</li>
</ol>
<p>Please note that you can load several files in parallel through separate database connections or from different nodes. It is also worth noting that stage always creates at least one shard and does not append to existing shards. You can use the method described below to append to previously created shards.</p>
</div>
<div class="section" id="incremental-loads-by-appending-to-existing-shards">
<h3>Incremental loads by appending to existing shards<a class="headerlink" href="#incremental-loads-by-appending-to-existing-shards" title="Permalink to this headline">¶</a></h3>
<p>The stage command always creates a new shard when it is used and is best suited for bulk loading of data. Using stage to load smaller data increments will result in many small shards which might not be ideal. In order to allow smaller, incremental loads into append distributed tables, Citus provides 2 user defined functions. They are master_create_empty_shard() and master_append_table_to_shard().</p>
<p>master_create_empty_shard() can be used to create new empty shards for a table. This function also replicates the empty shard to citus.shard_replication_factor number of nodes like the stage command.</p>
<p>master_append_table_to_shard() can be used to append the contents of a PostgreSQL table to an existing shard. This allows the user to control the shard to which the rows will be appended. It also returns the shard fill ratio which helps to make a decision on whether more data should be appended to this shard or if a new shard should be created.</p>
<p>To use the above functionality, you can first insert incoming data into a regular PostgreSQL table. You can then create an empty shard using master_create_empty_shard(). Then, using master_append_table_to_shard(), you can append the contents of the staging table to the specified shard, and then subsequently delete the data from the staging table. Once the shard fill ratio returned by the append function becomes close to 1, you can create a new shard and start appending to the new one.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">master_create_empty_shard</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span>
<span class="n">master_create_empty_shard</span>
<span class="o">---------------------------</span>
                <span class="mi">102089</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>

<span class="n">SELECT</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">master_append_table_to_shard</span><span class="p">(</span><span class="mi">102089</span><span class="p">,</span> <span class="s1">&#39;github_events_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;master-101&#39;</span><span class="p">,</span> <span class="mi">5432</span><span class="p">);</span>
<span class="n">master_append_table_to_shard</span>
<span class="o">------------------------------</span>
        <span class="mf">0.100548</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>To learn more about the two UDFs, their arguments and usage, please visit the <a class="reference internal" href="../reference/user_defined_functions.html#user-defined-functions"><span class="std std-ref">User Defined Functions Reference</span></a> section of the documentation.</p>
</div>
<div class="section" id="increasing-data-loading-performance">
<h3>Increasing data loading performance<a class="headerlink" href="#increasing-data-loading-performance" title="Permalink to this headline">¶</a></h3>
<p>The methods described above enable you to achieve high bulk load rates which are sufficient for most use cases. If you require even higher data load rates, you can use the functions described above in several ways and write scripts to better control sharding and data loading. For more information, you can consult the <a class="reference internal" href="../performance/scaling_data_ingestion.html#scaling-data-ingestion"><span class="std std-ref">Scaling Out Data Ingestion</span></a> section of our documentation.</p>
</div>
</div>
<div class="section" id="dropping-shards">
<h2>Dropping Shards<a class="headerlink" href="#dropping-shards" title="Permalink to this headline">¶</a></h2>
<p>In append distribution, users typically want to track data only for the last few months / years. In such cases, the shards that are no longer needed still occupy disk space. To address this, Citus provides a user defined function master_apply_delete_command() to delete old shards. The function takes a <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-delete.html">DELETE</a> command as input and deletes all the shards that match the delete criteria with their metadata.</p>
<p>The function uses shard metadata to decide whether or not a shard needs to be deleted, so it requires the WHERE clause in the DELETE statement to be on the distribution column. If no condition is specified, then all shards are selected for deletion. The UDF then connects to the worker nodes and issues DROP commands for all the shards which need to be deleted. If a drop query for a particular shard replica fails, then that replica is marked as TO DELETE. The shard replicas which are marked as TO DELETE are not considered for future queries and can be cleaned up later.</p>
<p>Please note that this function only deletes complete shards and not individual rows from shards. If your use case requires deletion of individual rows in real-time, please consider using the hash distribution method.</p>
<p>The example below deletes those shards from the github_events table which have all rows with created_at &lt;= &#8216;2014-01-01 00:00:00&#8217;. Note that the table is distributed on the created_at column.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">master_apply_delete_command</span><span class="p">(</span><span class="s1">&#39;DELETE FROM github_events WHERE created_at &lt;= &#39;&#39;2014-01-01 00:00:00&#39;&#39;&#39;</span><span class="p">);</span>
 <span class="n">master_apply_delete_command</span>
<span class="o">-----------------------------</span>
                           <span class="mi">3</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>To learn more about the function, its arguments and its usage, please visit the <a class="reference internal" href="../reference/user_defined_functions.html#user-defined-functions"><span class="std std-ref">User Defined Functions Reference</span></a> section of our documentation.</p>
</div>
<div class="section" id="dropping-tables">
<h2>Dropping Tables<a class="headerlink" href="#dropping-tables" title="Permalink to this headline">¶</a></h2>
<p>You can use the standard PostgreSQL <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-droptable.html">DROP TABLE</a>
command to remove your append distributed tables. As with regular tables, DROP TABLE removes any
indexes, rules, triggers, and constraints that exist for the target table. In addition, it also
drops the shards on the worker nodes and cleans up their metadata.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">github_events</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="hash_distribution.html" class="btn btn-neutral float-right" title="Hash Distribution" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="working_with_distributed_tables.html" class="btn btn-neutral" title="Working with distributed tables" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Citus Data.

    </p>
  </div> 

</footer>

          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32858865-1', 'auto');
  ga('send', 'pageview');

</script>
<script>
/**
* Function that tracks a click on an outbound link in Analytics.
* This function takes a valid URL string as an argument, and uses that URL string
* as the event label. Setting the transport method to 'beacon' lets the hit be sent
* using 'navigator.sendBeacon' in browser that support it.
*/
var trackOutboundLink = function(url) {
   ga('send', 'event', 'outbound', 'click', url, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script>

        </div>
      </div>

    </section>

  </div>
  
<h3>Versions</h3>
<ul>
    <li><a href="../../v5.2/index.html">v5.2</a></li>
    <li><a href="../../v5.1/dist_tables/append_distribution.html">v5.1</a></li>
    <li><a href="append_distribution.html">v5.0</a></li>
</ul>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>