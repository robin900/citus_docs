

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hash-Distributed Data &mdash; Citus 5.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Citus 5.1.0 documentation" href="../index.html"/>
        <link rel="next" title="Append-Distributed Data" href="tut-append-distribution.html"/>
        <link rel="prev" title="Start Demo Cluster" href="tut-cluster.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <div class="header">
  <div class="section-wrap"> 
              <div class="utility-nav">
              </div>
                      <a href="https://www.citusdata.com" title="Citus Data" rel="home" class="logo">
            <img src="../_static/images/citus-logo.png" alt="Citus Data">
          </a>
              <div class="clear"></div>
  </div>
  </div>
  <div class="nav-wrap menu">
    <div class="section-wrap">
      <ul>
        <li><a href="https://www.citusdata.com/product/citus">Product</a></li>
        <li><a href="https://www.citusdata.com/solutions/applications">Solutions</a></li>
        <li><a href="https://www.citusdata.com/blog">Blog</a></li>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
  </div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Citus
          

          
          </a>

          
            
            
              <div class="version">
                5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">About Citus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/what_is_citus.html">What is Citus?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/introduction_to_citus.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tut-cluster.html">Start Demo Cluster</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hash-Distributed Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="tut-append-distribution.html">Append-Distributed Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/development.html">Single-Machine Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/production.html">Multi-Machine Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/working_with_distributed_tables.html">Working with distributed tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/hash_distribution.html">Hash Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/append_distribution.html">Append Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/querying.html">Querying Distributed Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist_tables/postgresql_extensions.html">PostgreSQL extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/query_processing.html">Citus Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/scaling_data_ingestion.html">Scaling Out Data Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Cloud</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cloud/index.html">Citus Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/support.html">Support and Billing</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/upgrading_citus.html">Upgrading Citus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/transitioning_from_postgresql_to_citus.html">Transitioning From PostgreSQL to Citus</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/citus_sql_reference.html">Citus SQL Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_defined_functions.html">User Defined Functions Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/metadata_tables.html">Metadata Tables Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <a href="../index.html">Citus</a>
      <ul>
        <li><a href="/product/citus">Product</a></li>
        <li><a href="/solutions/applications">Solutions</a></li>
        <li><a href="/blog">Blog</a></li>
      </ul>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Hash-Distributed Data</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hash-distributed-data">
<h1>Hash-Distributed Data<a class="headerlink" href="#hash-distributed-data" title="Permalink to this headline">Â¶</a></h1>
<p>In this tutorial we&#8217;ll look at a stream of live wikipedia edits. Wikimedia is
kind enough to publish all changes happening across all their sites in real time;
this can be a lot of events!</p>
<p>This tutorial assumes you&#8217;ve set up a <a class="reference internal" href="tut-cluster.html#tut-cluster"><span class="std std-ref">single-machine demo cluster</span></a>.
Once your cluster is running, open a prompt to the master instance:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> citus-tutorial
bin/psql postgresql://:9700
</pre></div>
</div>
<p>This will open a new prompt. You can leave it at any time by hitting
<code class="kbd docutils literal"><span class="pre">Ctrl</span></code> + <code class="kbd docutils literal"><span class="pre">D</span></code>.</p>
<p>This time we&#8217;re going to make two tables.</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wikipedia_editors</span> <span class="p">(</span>
  <span class="n">editor</span> <span class="nb">TEXT</span> <span class="k">UNIQUE</span><span class="p">,</span> <span class="c1">-- The name of the editor</span>
  <span class="n">bot</span> <span class="nb">BOOLEAN</span><span class="p">,</span> <span class="c1">-- Whether they are a bot (self-reported)</span>

  <span class="n">edit_count</span> <span class="nb">INT</span><span class="p">,</span> <span class="c1">-- How many edits they&#39;ve made</span>
  <span class="n">added_chars</span> <span class="nb">INT</span><span class="p">,</span> <span class="c1">-- How many characters they&#39;ve added</span>
  <span class="n">removed_chars</span> <span class="nb">INT</span><span class="p">,</span> <span class="c1">-- How many characters they&#39;ve removed</span>

  <span class="n">first_seen</span> <span class="n">TIMESTAMPTZ</span><span class="p">,</span> <span class="c1">-- The time we first saw them edit</span>
  <span class="n">last_seen</span> <span class="n">TIMESTAMPTZ</span> <span class="c1">-- The time we last saw them edit</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wikipedia_changes</span> <span class="p">(</span>
  <span class="n">editor</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The editor who made the change</span>
  <span class="n">time</span> <span class="k">TIMESTAMP</span> <span class="k">WITH</span> <span class="n">TIME</span> <span class="k">ZONE</span><span class="p">,</span> <span class="c1">-- When they made it</span>

  <span class="n">wiki</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- Which wiki they edited</span>
  <span class="n">title</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The name of the page they edited</span>

  <span class="k">comment</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- The message they described the change with</span>
  <span class="n">minor</span> <span class="nb">BOOLEAN</span><span class="p">,</span> <span class="c1">-- Whether this was a minor edit (self-reported)</span>
  <span class="k">type</span> <span class="nb">TEXT</span><span class="p">,</span> <span class="c1">-- &quot;new&quot; if this created the page, &quot;edit&quot; otherwise</span>

  <span class="n">old_length</span> <span class="nb">INT</span><span class="p">,</span> <span class="c1">-- how long the page used to be</span>
  <span class="n">new_length</span> <span class="nb">INT</span> <span class="c1">-- how long the page is as of this edit</span>
<span class="p">);</span>
</pre></div>
</div>
<p>These tables are regular Postgres tables. We need to tell Citus that they
should be distributed tables, stored across the cluster.</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">master_create_distributed_table</span><span class="p">(</span>
  <span class="s1">&#39;wikipedia_changes&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;hash&#39;</span>
<span class="p">);</span>
<span class="k">SELECT</span> <span class="n">master_create_distributed_table</span><span class="p">(</span>
  <span class="s1">&#39;wikipedia_editors&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;hash&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>These say to store each table as a collection of shards, each responsible for
holding a different subset of the data. The shard a particular row belongs in
will be computed by hashing the <code class="docutils literal"><span class="pre">editor</span></code> column. The page on <a class="reference internal" href="../dist_tables/hash_distribution.html#hash-distribution"><span class="std std-ref">Hash Distribution</span></a>
goes into more detail.</p>
<p>Finally, create the shards:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">master_create_worker_shards</span><span class="p">(</span><span class="s1">&#39;wikipedia_editors&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="n">master_create_worker_shards</span><span class="p">(</span><span class="s1">&#39;wikipedia_changes&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>This tells Citus to create 16 shards for each table, and save 1 replica of
each. You can ask Citus to store multiple copies of each shard, which allows it
to recover from worker failures without losing data or dropping queries.
However, in this example cluster we only have 1 worker, so Citus would error
out if we asked it to store any more than 1 replica.</p>
<p>Now we&#8217;re ready to accept some data! <strong>Open a separate terminal</strong>
and run the data ingest script we&#8217;ve made for you in this new terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># - in a new terminal -</span>

<span class="nb">cd</span> citus-tutorial
scripts/collect-wikipedia-user-data postgresql://:9700
</pre></div>
</div>
<p>This should keep running and aggregating data on the users who are
editting right now. Let&#8217;s run some queries! If you run any of these
queries multiple times you&#8217;ll see the results update as more data
is ingested. Returning to our existing psql terminal we can ask
some simple questions, such as finding edits which were made by
bots:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- back in the original (psql) terminal</span>

<span class="k">SELECT</span> <span class="k">comment</span> <span class="k">FROM</span> <span class="n">wikipedia_changes</span> <span class="k">c</span><span class="p">,</span> <span class="n">wikipedia_editors</span> <span class="n">e</span>
<span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">editor</span> <span class="k">AND</span> <span class="n">e</span><span class="p">.</span><span class="n">bot</span> <span class="k">IS</span> <span class="k">true</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>Above, when we created our two tables, we partitioned them along the same
column and created an equal number of shards for each. Doing this means that
all data for each editor is kept on the same machine, or, colocated.</p>
<p>How many pages have been created by bots? By users?</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">bot</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">pages_created</span>
<span class="k">FROM</span> <span class="n">wikipedia_changes</span> <span class="k">c</span><span class="p">,</span>
     <span class="n">wikipedia_editors</span> <span class="n">e</span>
<span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">editor</span>
      <span class="k">AND</span> <span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;new&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">bot</span><span class="p">;</span>
</pre></div>
</div>
<p>Citus can also perform joins where the rows to be joined are not stored on the
same machine. But, joins involving colocated rows usually run <cite>faster</cite> than
their non-distributed versions, because they can run across all machines and
shards in parallel.</p>
<p>A surprising amount of the content in wikipedia is written by users who stop by
to make just one or two edits and don&#8217;t even bother to create an account. Their
username is just their ip address, which will look something like &#8216;95.180.5.193&#8217;
or &#8216;2607:FB90:25C8:8785:0:42:36E9:7E01&#8217;.</p>
<p>We can (using a very rough regex), find their edits:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">editor</span> <span class="k">SIMILAR</span> <span class="k">TO</span> <span class="s1">&#39;[0-9.A-F:]+&#39;</span> <span class="k">AS</span> <span class="n">ip_editor</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">edit_count</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">added_chars</span><span class="p">)</span> <span class="k">AS</span> <span class="n">added_chars</span>
<span class="k">FROM</span> <span class="n">wikipedia_editors</span> <span class="k">WHERE</span> <span class="n">bot</span> <span class="k">is</span> <span class="k">false</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">ip_editor</span><span class="p">;</span>
</pre></div>
</div>
<p>Usually, around a fifth of all non-bot edits are made from unregistered
editors. The real percentage is a lot higher, since &#8220;bot&#8221; is a user-settable
flag which many bots neglect to set.</p>
<p>This script showed a data layout which many Citus users choose. One
table stored a stream of events while another table stored some
aggregations of those events and made queries over them quick.</p>
<p>That&#8217;s all for now. To learn more about Citus continue to the
<a class="reference internal" href="tut-append-distribution.html#tut-append"><span class="std std-ref">next tutorial</span></a>, or, if you&#8217;re done with the
cluster, run this to stop the worker and master:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>bin/pg_ctl -D data/master stop
bin/pg_ctl -D data/worker stop
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tut-append-distribution.html" class="btn btn-neutral float-right" title="Append-Distributed Data" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tut-cluster.html" class="btn btn-neutral" title="Start Demo Cluster" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Citus Data.

    </p>
  </div> 

</footer>

          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32858865-1', 'auto');
  ga('send', 'pageview');

</script>
<script>
/**
* Function that tracks a click on an outbound link in Analytics.
* This function takes a valid URL string as an argument, and uses that URL string
* as the event label. Setting the transport method to 'beacon' lets the hit be sent
* using 'navigator.sendBeacon' in browser that support it.
*/
var trackOutboundLink = function(url) {
   ga('send', 'event', 'outbound', 'click', url, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script>

        </div>
      </div>

    </section>

  </div>
  
<h3>Versions</h3>
<ul>
    <li><a href="../../v5.2/tutorials/tut-hash-distribution.html">v5.2</a></li>
    <li><a href="tut-hash-distribution.html">v5.1</a></li>
    <li><a href="../../v5.0/index.html">v5.0</a></li>
</ul>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>