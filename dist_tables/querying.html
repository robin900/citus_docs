

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Querying Distributed Tables (SQL) &mdash; Citus 5.2.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Citus 5.2.1 documentation" href="../index.html"/>
        <link rel="next" title="PostgreSQL extensions" href="extensions.html"/>
        <link rel="prev" title="Ingesting, Modifying Data (DML)" href="dml.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>
  <script>
   window.intercomSettings = {
     app_id: "jfost7ih",
   };
  </script>
  <script>(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',intercomSettings);}else{var d=document;var i=function(){i.c(arguments)};i.q=[];i.c=function(args){i.q.push(args)};w.Intercom=i;function l(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/jfost7ih';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);}if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})()</script>
</head>

<body class="wy-body-for-nav" role="document">
  <div class="header">
  <div class="section-wrap"> 
              <div class="utility-nav">
              </div>
                      <a href="https://www.citusdata.com" title="Citus Data" rel="home" class="logo">
            <img src="../_static/images/citus-logo.png" alt="Citus Data">
          </a>
              <div class="clear"></div>
  </div>
  </div>
  <div class="nav-wrap menu">
    <div class="section-wrap">
      <ul>
        <li><a href="https://www.citusdata.com/product/citus">Product</a></li>
        <li><a href="https://www.citusdata.com/solutions/applications">Solutions</a></li>
        <li><a href="https://www.citusdata.com/blog">Blog</a></li>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
  </div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Citus
          

          
          </a>

          
            
            
              <div class="version">
                5.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">About Citus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/what_is_citus.html">What is Citus?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutcitus/introduction_to_citus.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tut-hash-distribution.html">Hash-Distributed Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/development.html">Single-Machine Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/production.html">Multi-Machine Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Tables</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Picking a Distribution Column</a></li>
<li class="toctree-l1"><a class="reference internal" href="ddl.html">Creating Distributed Tables (DDL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dml.html">Ingesting, Modifying Data (DML)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Querying Distributed Tables (SQL)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#aggregate-functions">Aggregate Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#count-distinct-aggregates">Count (Distinct) Aggregates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hyperloglog-column">HyperLogLog Column</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#limit-pushdown">Limit Pushdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joins">Joins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#broadcast-joins">Broadcast joins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#colocated-joins">Colocated joins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#repartition-joins">Repartition joins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#query-performance">Query Performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">PostgreSQL extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/query_processing.html">Citus Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/scaling_data_ingestion.html">Scaling Out Data Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Cloud</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cloud/index.html">Citus Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/support.html">Support and Billing</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Solutions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tech_soln/real_time_dashboards.html">Real Time Dashboards</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/upgrading_citus.html">Upgrading Citus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/transitioning_from_postgresql_to_citus.html">Transitioning From PostgreSQL to Citus</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/citus_sql_reference.html">Citus SQL Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/sql_workarounds.html">SQL Workarounds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_defined_functions.html">User Defined Functions Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/metadata_tables.html">Metadata Tables Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/append.html">Append Distribution</a></li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <a href="../index.html">Citus</a>
      <ul>
        <li><a href="/product/citus">Product</a></li>
        <li><a href="/solutions/applications">Solutions</a></li>
        <li><a href="/blog">Blog</a></li>
      </ul>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Querying Distributed Tables (SQL)</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="querying-distributed-tables-sql">
<span id="querying"></span><h1>Querying Distributed Tables (SQL)<a class="headerlink" href="#querying-distributed-tables-sql" title="Permalink to this headline">¶</a></h1>
<p>As discussed in the previous sections, Citus is an extension which extends the latest PostgreSQL for distributed execution. This means that you can use standard PostgreSQL <a class="reference external" href="http://www.postgresql.org/docs/9.5/static/sql-select.html">SELECT</a> queries on the Citus master for querying. Citus will then parallelize the SELECT queries involving complex selections, groupings and orderings, and JOINs to speed up the query performance. At a high level, Citus partitions the SELECT query into smaller query fragments, assigns these query fragments to workers, oversees their execution, merges their results (and orders them if needed), and returns the final result to the user.</p>
<p>In the following sections, we discuss the different types of queries you can run using Citus.</p>
<div class="section" id="aggregate-functions">
<span id="id1"></span><h2>Aggregate Functions<a class="headerlink" href="#aggregate-functions" title="Permalink to this headline">¶</a></h2>
<p>Citus supports and parallelizes most aggregate functions supported by PostgreSQL. Citus&#8217;s query planner transforms the aggregate into its commutative and associative form so it can be parallelized. In this process, the workers run an aggregation query on the shards and the master then combines the results from the workers to produce the final output.</p>
<div class="section" id="count-distinct-aggregates">
<span id="count-distinct"></span><h3>Count (Distinct) Aggregates<a class="headerlink" href="#count-distinct-aggregates" title="Permalink to this headline">¶</a></h3>
<p>Citus supports count(distinct) aggregates in several ways. If the count(distinct) aggregate is on the distribution column, Citus can directly push down the query to the workers. If not, Citus needs to repartition the underlying data in the cluster to parallelize count(distinct) aggregates and avoid pulling all rows to the master.</p>
<p>To address the common use case of count(distinct) approximations, Citus provides an option of using the HyperLogLog algorithm to efficiently calculate approximate values for the count distincts on non-distribution key columns.</p>
<p>To enable count distinct approximations, you can follow the steps below:</p>
<ol class="arabic simple">
<li>Download and install the hll extension on all PostgreSQL instances (the master and all the workers).</li>
</ol>
<p>Please visit the PostgreSQL hll <a class="reference external" href="https://github.com/aggregateknowledge/postgresql-hll">github repository</a> for specifics on obtaining the extension.</p>
<ol class="arabic simple" start="2">
<li>Create the hll extension on all the PostgreSQL instances</li>
</ol>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">EXTENSION</span> <span class="n">hll</span><span class="p">;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Enable count distinct approximations by setting the citus.count_distinct_error_rate configuration value. Lower values for this configuration setting are expected to give more accurate results but take more time for computation. We recommend setting this to 0.005.</li>
</ol>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SET</span> <span class="n">citus</span><span class="o">.</span><span class="n">count_distinct_error_rate</span> <span class="n">to</span> <span class="mf">0.005</span><span class="p">;</span>
</pre></div>
</div>
<p>After this step, you should be able to run approximate count distinct queries on any column of the table.</p>
</div>
<div class="section" id="hyperloglog-column">
<h3>HyperLogLog Column<a class="headerlink" href="#hyperloglog-column" title="Permalink to this headline">¶</a></h3>
<p>Certain users already store their data as HLL columns. In such cases, they can dynamically roll up those data by creating custom aggregates within Citus.</p>
<p>As an example, if you want to run the hll_union aggregate function on your data stored as hll, you can define an aggregate function like below :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">AGGREGATE</span> <span class="nb">sum</span> <span class="p">(</span><span class="n">hll</span><span class="p">)</span>
<span class="p">(</span>
<span class="n">sfunc</span> <span class="o">=</span> <span class="n">hll_union_trans</span><span class="p">,</span>
<span class="n">stype</span> <span class="o">=</span> <span class="n">internal</span><span class="p">,</span>
<span class="n">finalfunc</span> <span class="o">=</span> <span class="n">hll_pack</span>
<span class="p">);</span>
</pre></div>
</div>
<p>You can then call sum(hll_column) to roll up those columns within the database. Please note that these custom aggregates need to be created both on the master and the workers.</p>
</div>
</div>
<div class="section" id="limit-pushdown">
<span id="id2"></span><h2>Limit Pushdown<a class="headerlink" href="#limit-pushdown" title="Permalink to this headline">¶</a></h2>
<p>Citus also pushes down the limit clauses to the shards on the workers wherever possible to minimize the amount of data transferred across network.</p>
<p>However, in some cases, SELECT queries with LIMIT clauses may need to fetch all rows from each shard to generate exact results. For example, if the query requires ordering by the aggregate column, it would need results of that column from all shards to determine the final aggregate value. This reduces performance of the LIMIT clause due to high volume of network data transfer. In such cases, and where an approximation would produce meaningful results, Citus provides an option for network efficient approximate LIMIT clauses.</p>
<p>LIMIT approximations are disabled by default and can be enabled by setting the configuration parameter citus.limit_clause_row_fetch_count. On the basis of this configuration value, Citus will limit the number of rows returned by each task for aggregation on the master. Due to this limit, the final results may be approximate. Increasing this limit will increase the accuracy of the final results, while still providing an upper bound on the number of rows pulled from the workers.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SET</span> <span class="n">citus</span><span class="o">.</span><span class="n">limit_clause_row_fetch_count</span> <span class="n">to</span> <span class="mi">10000</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="joins">
<span id="id3"></span><h2>Joins<a class="headerlink" href="#joins" title="Permalink to this headline">¶</a></h2>
<p>Citus supports equi-JOINs between any number of tables irrespective of their size and distribution method. The query planner chooses the optimal join method and join order based on the statistics gathered from the distributed tables. It evaluates several possible join orders and creates a join plan which requires minimum data to be transferred across network.</p>
<p>To determine the best join strategy, Citus treats large and small tables differently while executing JOINs. The distributed tables are classified as large and small on the basis of the configuration entry citus.large_table_shard_count (default value: 4). The tables whose shard count exceeds this value are considered as large while the others small. In practice, the fact tables are generally the large tables while the dimension tables are the small tables.</p>
<div class="section" id="broadcast-joins">
<h3>Broadcast joins<a class="headerlink" href="#broadcast-joins" title="Permalink to this headline">¶</a></h3>
<p>This join type is used while joining small tables with each other or with a large table. This is a very common use case where you want to join the keys in the fact tables (large table) with their corresponding dimension tables (small tables). Citus replicates the small table to all workers where the large table&#8217;s shards are present. Then, all the joins are performed locally on the workers in parallel. Subsequent join queries that involve the small table then use these cached shards.</p>
</div>
<div class="section" id="colocated-joins">
<h3>Colocated joins<a class="headerlink" href="#colocated-joins" title="Permalink to this headline">¶</a></h3>
<p>To join two large tables efficiently, it is advised that you distribute them on the same columns you used to join the tables. In this case, the Citus master knows which shards of the tables might match with shards of the other table by looking at the distribution column metadata. This allows Citus to prune away shard pairs which cannot produce matching join keys. The joins between remaining shard pairs are executed in parallel on the workers and then the results are returned to the master.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to benefit most from colocated joins, you should hash distribute your tables on the join key and use the same number of shards for both tables. If you do this, each shard will join with exactly one shard of the other table. Also, the shard creation logic will ensure that shards with the same distribution key ranges are on the same workers. This means no data needs to be transferred between the workers, leading to faster joins.</p>
</div>
</div>
<div class="section" id="repartition-joins">
<h3>Repartition joins<a class="headerlink" href="#repartition-joins" title="Permalink to this headline">¶</a></h3>
<p>In some cases, you may need to join two tables on columns other than the distribution column. For such cases, Citus also allows joining on non-distribution key columns by dynamically repartitioning the tables for the query.</p>
<p>In such cases the table(s) to be partitioned are determined by the query optimizer on the basis of the distribution columns, join keys and sizes of the tables. With repartitioned tables, it can be ensured that only relevant shard pairs are joined with each other reducing the amount of data transferred across network drastically.</p>
<p>In general, colocated joins are more efficient than repartition joins as repartition joins require shuffling of data. So, you should try to distribute your tables by the common join keys whenever possible.</p>
</div>
</div>
<div class="section" id="query-performance">
<span id="id4"></span><h2>Query Performance<a class="headerlink" href="#query-performance" title="Permalink to this headline">¶</a></h2>
<p>Citus parallelizes incoming queries by breaking it into multiple fragment queries (&#8220;tasks&#8221;) which run on the worker shards in parallel. This allows Citus to utilize the processing power of all the nodes in the cluster and also of individual cores on each node for each query. Due to this parallelization, you can get performance which is cumulative of the computing power of all of the cores in the cluster leading to a dramatic decrease in query times versus PostgreSQL on a single server.</p>
<p>Citus employs a two stage optimizer when planning SQL queries. The first phase involves converting the SQL queries into their commutative and associative form so that they can be pushed down and run on the workers in parallel. As discussed in previous sections, choosing the right distribution column and distribution method allows the distributed query planner to apply several optimizations to the queries. This can have a significant impact on query performance due to reduced network I/O.</p>
<p>Citus’s distributed executor then takes these individual query fragments and sends them to worker PostgreSQL instances. There are several aspects of both the distributed planner and the executor which can be tuned in order to improve performance. When these individual query fragments are sent to the workers, the second phase of query optimization kicks in. The workers are simply running extended PostgreSQL servers and they apply PostgreSQL&#8217;s standard planning and execution logic to run these fragment SQL queries. Therefore, any optimization that helps PostgreSQL also helps Citus. PostgreSQL by default comes with conservative resource settings; and therefore optimizing these configuration settings can improve query times significantly.</p>
<p>We discuss the relevant performance tuning steps in the <a class="reference internal" href="../performance/performance_tuning.html#performance-tuning"><span class="std std-ref">Query Performance Tuning</span></a> section of the documentation.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extensions.html" class="btn btn-neutral float-right" title="PostgreSQL extensions" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dml.html" class="btn btn-neutral" title="Ingesting, Modifying Data (DML)" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Citus Data.

    </p>
  </div> 

</footer>

          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32858865-1', 'auto');
  ga('send', 'pageview');

</script>
<script>
/**
* Function that tracks a click on an outbound link in Analytics.
* This function takes a valid URL string as an argument, and uses that URL string
* as the event label. Setting the transport method to 'beacon' lets the hit be sent
* using 'navigator.sendBeacon' in browser that support it.
*/
var trackOutboundLink = function(url) {
   ga('send', 'event', 'outbound', 'click', url, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script>

        </div>
      </div>

    </section>

  </div>
  
<h3>Versions</h3>
<ul>
    <li><a href="../v5.2/dist_tables/querying.html">v5.2</a></li>
</ul>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.2.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>